<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css"
        integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

    <link rel="stylesheet" href="style.css">

    <title>Bluesky verification</title>
</head>

<body class="text-center">
    <form class="form-login" onsubmit="return false">
        <img
            src="https://upload.wikimedia.org/wikipedia/commons/thumb/7/7a/Bluesky_Logo.svg/272px-Bluesky_Logo.svg.png">
        <h1 class="h3 mb-3 font-weight-normal">&nbsp;<br>Enter your Bluesky handle, select the verification
            source and enter your ID there</h1>
        <label for="inputBlueSkyHandle" class="sr-only">Bluesky handle</label>
        <input type="text" id="inputBlueSkyHandle" class="form-control" placeholder="Bluesky handle" required autofocus>
        <div class="left"><small class="text-muted">This is your handle on Bluesky. If you open your profile, you see it
                below your name,
                after the @.</small></div>
        <label for="selectVerificationSource" class="sr-only">Verification source</label>
        <select class="form-select form-control" id="selectSource">
            <option value="mvp">Microsoft Most Valuable Professional</option>
            <option value="rd">Microsoft Regional Directors (not implemented yet)</option>
            <option value="captain">Docker Captains (not implemented yet)</option>
        </select>
        <div class="left"><small class="text-muted">Select the source for verifying you.</small></div>
        <label for="input" class="sr-only">Verification ID</label>
        <input type="text" id="inputVerificationID" class="form-control" placeholder="Verification ID" required>
        <div class="left"><small class="text-muted" id="explanationText">This is you MVP ID, a GUID. If you open your
                profile on <a href="https://mvp.microsoft.com" target="_blank">mvp.microsoft.com</a>, it is the last
                part of the URL,
                after the last /</small></div>
        <p>&nbsp;</p>
        <button class="btn btn-lg btn-primary btn-block" onclick="validate()">Verify</button>
        <div class="messageContainer" id="messageContainer"></div>
        <p class="left">This little tool works by checking first whether the Bluesky handle that you enter is a valid one and
            then whether the verification ID that you enter is valid for the selected source. Last it checks whether the Bluesky
            handle appears on the selected source with that ID. If all is valid, you will be added to the appropriate Bluesky
            starter packs and lists that correspond to the selected source. The idea is that you own the site on the selected
            source or at least control the content, so if there is a link to the given Bluesky handle there, it means that you
            are the owner of the site and the Bluesky handle. If anyone trusts the source, then they can also trust that it is
            you on Bluesky.
            <br>&nbsp;<br>
            As a positive side effect, we get a nice collection of Starter Packs and lists fo those sources with only verified
            members.
            <br>&nbsp;<br>
            Please note that in order to validate continuously whether the verification is still OK, we
            store your
            Bluesky handle and the verification ID in our backend. We will never share that data with anyone, but if you
            don't want the combination of you Bluesky handle and the verification ID to be stored with us, please don't
            use this service.</p>
    </form>

    <script>
        function updateVerification() {
            var select = document.getElementById("mvpAwards");
            var selectedValue = select.options[select.selectedIndex].value;
            document.getElementById("selectedAward").innerText = selectedValue;
        }
        async function validate() {
            bskyHandle = document.getElementById("inputBlueSkyHandle").value;
            verificationId = document.getElementById("inputVerificationID").value;
            if (bskyHandle === "" || verificationId === "") {
                return;
            }
            const url = "/validate-mvp";
            try {
                const response = await fetch(url, {
                    method: "POST",
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ bskyHandle: bskyHandle, mvpId: verificationId }),
                });
                if (!response.ok) {
                    throw new Error(`An error occured: ${await response.text()}`);
                }

                const addedElements = await response.json();
                const messageContainer = document.getElementById("messageContainer");
                var links = "";
                addedElements.forEach(element => {
                    links = links + `<li><a href="${element.url}" target="_blank">${element.titel}</a></li>`;
                });
                messageContainer.innerHTML = `
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        Successfully verified you! You are now part of the following on Bluesky:<br>
                        <ul>
                        ${links}
                        </ul>
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    </div>
                `;
            } catch (error) {
                console.error(error.message);
                showAlert(error.message);
            }
        }
        function showAlert(message) {
            const messageContainer = document.getElementById("messageContainer");
            messageContainer.innerHTML = `
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            </div>
        `;
        }
    </script>

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.3/dist/umd/popper.min.js"
        integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/js/bootstrap.min.js"
        integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
        crossorigin="anonymous"></script>
</body>

</html>